---
import questions from '../data/questions.json';
---

<div class="max-w-3xl mx-auto p-4">
  <div class="mb-8 text-center">
    <p class="text-gray-600 mb-6">Pour un apprentissage efficace, prenez des notes sur papier.</p>

    <div class="flex gap-8 justify-center">
      <div class="text-center">
        <div class="text-sm text-gray-500 mb-1">Progress</div>
        <div id="progress" class="text-2xl font-bold text-blue-600">0 %</div>
      </div>
      <div class="text-center">
        <div class="text-sm text-gray-500 mb-1">Success</div>
        <div id="success" class="text-2xl font-bold text-green-600">0 %</div>
      </div>
    </div>
  </div>

  <div id="questions-container" class="space-y-6">
    {questions.map((q, index) => (
      <div
        class="question-card bg-white rounded-xl shadow-md p-6 border-2 border-transparent transition-all duration-300"
        data-question-id={q.id}
        data-correct={q.correctIndex}
      >
        <h3 class="font-semibold text-lg mb-4 text-gray-800">
          <span class="text-blue-600 mr-2">{index + 1}.</span>
          {q.question}
        </h3>

        <div class="space-y-2">
          {q.options.map((option, optIndex) => (
            <button
              class="option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 cursor-pointer"
              data-option-index={optIndex}
            >
              <code class="text-sm">{option}</code>
            </button>
          ))}
        </div>

        <div class="feedback mt-4 hidden">
          <p class="feedback-text text-sm font-medium"></p>
        </div>
      </div>
    ))}
  </div>

  <div id="final-result" class="hidden mt-8 p-6 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl text-white text-center">
    <h2 class="text-2xl font-bold mb-2">Quiz terminé !</h2>
    <p id="final-score" class="text-xl"></p>
    <button id="restart-btn" class="mt-4 px-6 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-gray-100 transition-colors cursor-pointer">
      Recommencer
    </button>
  </div>
</div>

<script>
  const questionCards = document.querySelectorAll('.question-card');
  const progressEl = document.getElementById('progress');
  const successEl = document.getElementById('success');
  const finalResult = document.getElementById('final-result');
  const finalScore = document.getElementById('final-score');
  const restartBtn = document.getElementById('restart-btn');

  let answeredCount = 0;
  let correctCount = 0;
  const totalQuestions = questionCards.length;

  function updateStats() {
    const progressPercent = Math.round((answeredCount / totalQuestions) * 100);
    const successPercent = Math.round((correctCount / totalQuestions) * 100);

    progressEl!.textContent = `${progressPercent} %`;
    successEl!.textContent = `${successPercent} %`;

    if (answeredCount === totalQuestions) {
      finalResult!.classList.remove('hidden');
      finalScore!.textContent = `Vous avez ${correctCount} bonnes réponses sur ${totalQuestions} (${successPercent}%)`;
    }
  }

  questionCards.forEach(card => {
    const correctIndex = parseInt(card.getAttribute('data-correct')!);
    const options = card.querySelectorAll('.option-btn');
    const feedback = card.querySelector('.feedback') as HTMLElement;
    const feedbackText = card.querySelector('.feedback-text') as HTMLElement;
    let answered = false;

    options.forEach((btn, index) => {
      btn.addEventListener('click', () => {
        if (answered) return;
        answered = true;
        answeredCount++;

        const isCorrect = index === correctIndex;

        if (isCorrect) {
          correctCount++;
          btn.classList.remove('border-gray-200');
          btn.classList.add('border-green-500', 'bg-green-50');
          card.classList.add('border-green-400');
          feedbackText.textContent = '✓ Correct !';
          feedbackText.classList.add('text-green-600');
        } else {
          btn.classList.remove('border-gray-200');
          btn.classList.add('border-red-500', 'bg-red-50');
          card.classList.add('border-red-400');
          options[correctIndex].classList.remove('border-gray-200');
          options[correctIndex].classList.add('border-green-500', 'bg-green-50');
          feedbackText.textContent = '✗ Incorrect. La bonne réponse est indiquée en vert.';
          feedbackText.classList.add('text-red-600');
        }

        feedback.classList.remove('hidden');

        options.forEach(b => {
          b.classList.remove('hover:border-blue-400', 'hover:bg-blue-50', 'cursor-pointer');
          b.classList.add('cursor-default');
        });

        updateStats();
      });
    });
  });

  restartBtn?.addEventListener('click', () => {
    location.reload();
  });
</script>
